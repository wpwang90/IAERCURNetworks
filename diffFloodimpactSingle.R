rm(list=ls())#Supra Matrix
require(igraph)
setwd("C:\\Users\\woqie\\Mac文档\\研究\\BU\\河流公路铁路耦合系统\\")
source(".\\程序\\produceNetwork.R")
source(".\\程序\\attackPointGenerater.R")
source(".\\程序\\attackShellLocalGenerater.R")



#################################################可重复性Code#############################
load(paste0(".\\结果\\TexasRoadGiantREsult.Rdata"))
#Ggroad=gRoad$g



temp=components(Ggroad);
maxCize=max(temp$csize)
tempIndex=which(temp$membership!=which.max(table(temp$membership)))
#write.table(zz[tempIndex,],file=".\\数据\\notInLGUSA.csv")

#######################################Read runoff#######################
#runoffNameList=c("Guangxi","Henan","Hunan","Sichuan","Zhejiang")
runoffNameList=c("Florida","Illinois","Iowa","Michigan","Minnesota","NewYork","Ohio","Tennessee","Texas")

for(kIter in 1:length(runoffNameList)){
  
  runoffName=runoffNameList[kIter]
  test=c(1:9,c(1:30)*10);
  Res1=c();
  Res21=c();#LG
  Res22=c();#LG2
  for(i in 1:length(test)){
    fileNameTemp=paste0(".\\数据\\淹没结果\\AmericaState\\",runoffName);
    fileNameTemp=paste0(fileNameTemp,"\\runoff");
    fileNameTemp=paste0(fileNameTemp,test[i]);
    fileNameTemp=paste0(fileNameTemp,".txt")
    wchoice=read.table(fileNameTemp,sep = ",",header = TRUE)
    wwdim=dim(wchoice)
    
    wchoice=wchoice[(which(wchoice[,wwdim[2]]>0)),2];
    wtemptemp=setdiff(wchoice,intersect(wchoice,tempIndex))
    
    
    Res1=c(Res1,length(wtemptemp))
    gAfter=delete.vertices(Ggroad,union(wchoice,tempIndex))
    
    
    temp=components(gAfter);
    #maxCizeAfter=max(temp$csize)
    maxCizeAfter=sort(temp$csize,decreasing = TRUE)
    Res21=c(Res21,maxCizeAfter[1])
    Res22=c(Res22,maxCizeAfter[2])
    #maxCizeAfter[2]
  }
  
  fileNameTemp=paste0(".\\数据\\淹没结果\\AmericaState\\",runoffName);
  fileNameTemp=paste0(fileNameTemp,"\\");
  fileNameTemp=paste0(fileNameTemp,runoffName);
  fileNameTemp=paste0(fileNameTemp,"TotalRoad.txt")
  wTotalRoad=read.table(fileNameTemp,sep = ",",header = TRUE)
  wTotalRoad=wTotalRoad[,2]
  wTotalRoad=setdiff(wTotalRoad,intersect(wTotalRoad,tempIndex))
  
  
  
  ############################Read runoff######################################
  gRoad$g=delete.vertices(Ggroad,tempIndex)
  V(gRoad$g)$name=c(1:gorder(gRoad$g))
  plot(degree.distribution(gRoad$g), xlab="node degree")
  lines(degree.distribution(gRoad$g))
  
  
  afterAttackRandomTotal1=0;#LG
  afterAttackRandomShellTotal1=0;
  afterAttackRandomTotal2=0;#LG2
  afterAttackRandomShellTotal2=0;
  
  iTersum=20;
  for(iIter in 1:iTersum){
    gRoad$g=Ggroad;
    gRoad$g=delete.vertices(gRoad$g,tempIndex)
    V(gRoad$g)$name=c(1:gorder(gRoad$g))
    
    attackRandom=attackPointGenerater(gRoad$g,gRoad$g,1)#1随机＿蓄意＿
    attackRandomShell=attackShellLocalGenerater(gRoad$g,gRoad$g,3)
    
    afterAttackRandom1=c();#LG
    afterAttackRandomShell1=c();
    afterAttackRandom2=c();#LG2
    afterAttackRandomShell2=c();
    
    afterAttackRandomSum=c();
    
    #for(i in 1:length(attackRandom$twchoice)){
    for(i in 1:(max(Res1)+100)){
      if(i%%100==1){
        gAfter=delete.vertices(gRoad$g,attackRandom$twchoice[1:i])
        temp=components(gAfter);
        #maxCizeAfter=max(temp$csize)
        
        maxCizeAfter=sort(temp$csize,decreasing = TRUE)
        afterAttackRandom1=c(afterAttackRandom1,maxCizeAfter[1]);
        afterAttackRandom2=c(afterAttackRandom2,maxCizeAfter[2]);
        
        gAfter=delete.vertices(gRoad$g,attackRandomShell$twchoice[1:i])
        temp=components(gAfter);
        
        maxCizeAfter=sort(temp$csize,decreasing = TRUE)
        afterAttackRandomShell1=c(afterAttackRandomShell1,maxCizeAfter[1]);
        afterAttackRandomShell2=c(afterAttackRandomShell2,maxCizeAfter[2]);
        
        
        
        afterAttackRandomSum=c(afterAttackRandomSum,i);
      }
    }
    afterAttackRandomTotal1=afterAttackRandomTotal1+afterAttackRandom1;
    afterAttackRandomShellTotal1=afterAttackRandomShellTotal1+afterAttackRandomShell1;
    
    afterAttackRandomTotal2=afterAttackRandomTotal2+afterAttackRandom2;
    afterAttackRandomShellTotal2=afterAttackRandomShellTotal2+afterAttackRandomShell2;
  }
  
  afterAttackRandomTotal2[which(is.na(afterAttackRandomTotal2))]=0;
  afterAttackRandomShellTotal2[which(is.na(afterAttackRandomShellTotal2))]=0;
  Res22[which(is.na(Res22))]=0;
  
  
  xlimmin=0.99999*min(c(Res1,afterAttackRandomSum));
  xlimmax=1.00001*max(c(Res1,afterAttackRandomSum));
  ylimmin=0.99999*min(c(Res21,afterAttackRandomTotal1/iTersum,afterAttackRandomShellTotal1/iTersum));
  ylimmax=1.00001*max(c(Res21,afterAttackRandomTotal1/iTersum,afterAttackRandomShellTotal1/iTersum));
  
  
  
  
  pdf(file=paste0(".\\结果\\",paste0(runoffName,"RoadUnderAttacks.pdf")))
  plot(Res1,Res21,col="blue",pch=1,ylab="Giant connected components",,xlim=c(xlimmin,xlimmax),ylim=c(ylimmin,ylimmax), xlab="Attacked road intersections")
  lines(Res1,Res21,col="blue",pch=1)
  lines(afterAttackRandomSum,afterAttackRandomTotal1/iTersum,col="red",pch=2)
  lines(afterAttackRandomSum,afterAttackRandomShellTotal1/iTersum,col="green",pch=3)
  legend("topright", c("Flooding","Random attack","Localized attack"),pch = c(1, 2,3),col=c("blue","red","green"),cex=1)
  dev.off()
  
  ylimmin2=0.99999*min(c(Res22,afterAttackRandomTotal2/iTersum,afterAttackRandomShellTotal2/iTersum));
  ylimmax2=1.00001*max(c(Res22,afterAttackRandomTotal2/iTersum,afterAttackRandomShellTotal2/iTersum));
  
  pdf(file=paste0(".\\结果\\",paste0(runoffName,"RoadUnderAttacksSecondGcs.pdf")))
  plot(Res1,Res22,col="blue",pch=1,ylab="Second Giant connected components",,xlim=c(xlimmin,xlimmax),ylim=c(ylimmin2,ylimmax2), xlab="Attacked road intersections")
  lines(Res1,Res22,col="blue",pch=1)
  lines(afterAttackRandomSum,afterAttackRandomTotal2/iTersum,col="red",pch=2)
  lines(afterAttackRandomSum,afterAttackRandomShellTotal2/iTersum,col="green",pch=3)
  legend("topright", c("Flooding","Random attack","Localized attack"),pch = c(1, 2,3),col=c("blue","red","green"),cex=1)
  dev.off()
  
  write.csv(Res1,paste0(".\\结果\\",paste0(runoffName,"RoadNodesAttackedByFlood.csv")))
  write.csv(Res21,paste0(".\\结果\\",paste0(runoffName,"RoadGiantCsAttackedByFlood.csv")))
  write.csv(afterAttackRandomSum,paste0(".\\结果\\",paste0(runoffName,"RoadNodesAttackedByRandom.csv")))
  write.csv(afterAttackRandomTotal1/iTersum,paste0(".\\结果\\",paste0(runoffName,"RoadGiantCsAttackedByRandom.csv")))
  write.csv(afterAttackRandomSum,paste0(".\\结果\\",paste0(runoffName,"RoadNodesAttackedByLocal.csv")))
  write.csv(afterAttackRandomShellTotal1/iTersum,paste0(".\\结果\\",paste0(runoffName,"RoadGiantCsAttackedByLocal.csv")))
  write.csv(Res22,paste0(".\\结果\\",paste0(runoffName,"RoadSecondCsAttackedByFlood.csv")))
  write.csv(afterAttackRandomTotal2/iTersum,paste0(".\\结果\\",paste0(runoffName,"RoadSecondCsAttackedByRandom.csv")))
  write.csv(afterAttackRandomShellTotal2/iTersum,paste0(".\\结果\\",paste0(runoffName,"RoadSecondCsAttackedByLocal.csv")))
  write.csv(Res1/length(wTotalRoad),paste0(".\\结果\\",paste0(runoffName,"RoadNodesAttackedRateByFlood.csv")))
  write.csv(Res21/235962,paste0(".\\结果\\",paste0(runoffName,"RoadGiantCsAttackedTotalRateByFlood.csv")))
}
